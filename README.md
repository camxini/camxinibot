浙江大学 智能移动技术 小车避障作业 2025.3.27

洪晨辉 杨佳昕 汤坤逸

你好学弟，拿去用吧。但是要动脑子哦，这玩意说实话写的挺屎的。
是的，这个仓库里面的东西并不是最终版，但是也差不多了。原实验报告如下：

# 智能移动技术小车动态避障报告

本实验力图完成：

> 1. 进行路径规划，躲避16个静态小车
> 2. 在其中划拨5移动小车，躲避动态小车
> 3. 在无碰情况下尽量增加小车速度

考虑到足球小车同时完成静态及动态任务，需平衡全图及局部情况，我们的思路为在每次起始时利用 **A-Star** 完成 **一次** 全局规划，之后在过程中利用 **DWA** 避开局部障碍物。

---
## 算法简介

### A-Star

A-Star算法在搜索路径时，会综合考虑两个代价函数：

- **已产生路径代价**：`g(n)`，从起点到当前节点 `n` 的实际代价。
- **估算代价**：`h(n)`，从当前节点 `n` 到目标节点的估计代价（启发式函数）。
- **总代价**：`f(n) = g(n) + h(n)`，优先扩展 `f(n)` 最小的节点。

具体操作中需要结合 **随机采样** 和 **KD-Tree** ，过程如下：

##### **(1) 预处理**
- 解析 `vision` 数据，提取 **障碍物信息**（蓝/黄机器人坐标）。
- 构建 **KD-Tree**，用于快速查找最近障碍物。

##### **(2) 采样 (`sampling()`)**
- 生成 `N_SAMPLE` 个随机点，并确保：
  - **位于地图范围内**
  - **不靠近障碍物**
- **起点和终点** 必须加入采样点。

##### **(3) 生成路径图 (`generate_roadmap()`)**
- 通过 **KD-Tree 最近邻搜索** 连接 `KNN` 个邻居，构建**无向图**。
- **碰撞检测 (`check_obs()`)**：
  - 过长路径直接舍弃。
  - 以 `robot_size + avoid_dist` 为步长，检测路径上是否有障碍物，有则舍弃。

##### **(4) 搜索 (`Astar_search()`)**
- 使用 `f(n) = g(n) + h(n)` 计算代价：
  - `g(n)`：当前路径长度
  - `h(n)`：目标点的欧几里得距离
- 采用 **启发式搜索**，最终回溯找到最优路径。

	需要注意的是，本实验采用的A-Star搜索路径以选取离散采样点的形式表征，并不连线。在小车运动过程中，会选取与其距离为`reach_dist` 外的最近点为参照点，来给 **DWA** 使用。见下轨迹评估。

---
### DWA

也即动态窗口法，为 **基于速度空间** 的 **局部路径规划** 。具体步骤如下：

#### **(1) 采样速度空间**
- 计算 **可行速度窗口** (Dynamic Window)，限制在：
  - **机器人运动学约束**
  - **动态约束 (最大加速度/减速度)**
  - **避障约束 (避免碰撞)**

#### **(2) 轨迹模拟**
- 在**速度窗口内**，基于不同速度 `(v, ω)` 生成多个轨迹，预测一小段时间内的运动情况。其差分推算为：

$$
\begin{aligned}
\Delta\theta &= w \Delta t \\
\Delta x & = -\frac{v}{w} (\sin(\theta) - \sin(\theta + \Delta\theta)) \\
\Delta y &= \frac{v}{w} (\cos(\theta) - \cos(\theta + \Delta\theta)) \\
\end{aligned}
$$
- 该轨迹为圆弧状

#### **(3) 轨迹评估**
- 计算**评价函数** `G = α * heading + β * clearance + γ * velocity`：
  - **heading**：到目标的朝向误差
  - **clearance**：与障碍物的安全距离
  - **velocity**：前进速度
  
	事实上，本实验中为了使得路径尽量靠近全局规划点，还多用了一个`target`,代表与 **A-Star** 路径上的参照点的距离，也即有`G = G + δ * target` 。

#### **(4) 选择最优速度**
- 选择 `G` 评分最高的 `(v, ω)` 作为下一时刻的速度指令。

#### **(5) 障碍物预测与绕行**
在更快速的版本当中，还采用了一个`direction`权重项。记录动态障碍物上次的位置和现有位置比较以获取小车眼下的最近的动态障碍物的运动趋势。根据运动趋势增加`Direction`权重来避免小车采用追及的方式从小车前绕过障碍物，也就避免可能发生的碰撞。于是有`G' = G + ε * direction` 

### Main

对于每一次的运动首先进行一次A\*的全局规划，再逐个以该全局轨迹上的点作为目标点，DWA以此目标点进行局部路径规划和运动。

在更快速的版本当中DWA与Main用一个`current_traj_close`进行通信，来使得小车避免在靠近终点时出现急转的问题，并且能更快地抵达终点。见改进方法中的描述。

---

## 实验结果

所有simple及hard任务都顺利完成，碰撞次数为0次。如视频所示。

更快速的版本成功率略微降低，预估85%，但速度提升140%。暂无视频。

---

## 改进方法

### 改进方法

**(1)** 目前成功率在95%以上，不成功部分是由于小车并没有对自己行进方向侧面的障碍物进行检测，导致障碍物一头撞上来。考虑添加侧面避障方案。

**(2)** 小车的最大速度受到限制，可以适当调大最大线速度及最大角速度，但会带来漂移问题，需要额外的算法来优化。

**(3)** 目前可移动障碍物周围的十字形障碍和其他障碍视为同一类，会导致小车在可移动障碍物前面出现致命的异常停车。
可以建立新的障碍物类别obs_moving_obs, 当小车被该类型障碍物覆盖时，应加速逃离而不是立刻停车（虽然这种情况很少见）。

### 实验过程中的改进

**(1)** 在一开始我们确定用A\*算法和DWA局部规划的算法来完成本题，此时的A\*算法是动态的规划，每隔一段时间重新进行全局规划。但是该方法和DWA的局部规划的协调存在问题。

**(2)** 基于此我们确定让A\*算法仅仅规划一次，为了解决DWA算法的局部避障存在缺陷，我们采用一个权重计算的公式来更好地控制小车局部避障时地速度和角速度。但是提升速度后效果不佳。

**(3)** 尝试引入VO算法增强动态障碍物的避障效果，依然效果不佳，于是我们适当重构代码逻辑，重写DWA局部避障算法和弥补A\*算法当中的缺陷。

**(4)** 起步后由于速度快，且朝向并未变更，容易规划出一个漂移路径。然而，由于小车的漂移路径和真实路径会有偏差，他容易一头栽上起始点附近的障碍。为了避免漂移惨剧发生，我们在前几个规划点上等比例缩放了角速度和速度。

**(5)** DWA表现一直不佳。经检查，前两版DWA具有致命的问题：他的差分公式是直线的！修正后，再加入了较大的避让距离惩罚，小车的成功率先从80%降低到了50%（很神奇吧？），而后经过调参增加到90%。

**(6)** 第四、五版（小版本号）存在小车像老奶奶过马路一样踟蹰不前的问题。经过将近一周的调试，我们发现这是小车选择的`target_dist`及DWA规划轨迹不够远导致的。这很好理解，开车时也要眼观六路耳听八方嘛。于是，第六版大幅增加此两项，成功将成功率提升到单轮近100%。

### 更快速的版本

我们提交的log和视频为group5_task1和group5_task2当中代码的运行结果，另外有group5_risk为速度更快的版本，主要解决如下问题：
1. 小车绕行时会选择和障碍物运动同方向超越，往往引发碰撞。通过新增权重项，引导小车从后侧绕行或加速通过。
2. 小车到达终点前会选择大幅度转向（视频1中存在此现象）。判别预测的运动轨迹是否经过终点，如果经过则保持此运动模式到达终点并停止。

---

## 附：成员工作

 - **洪晨辉**：总领。理论框架研究，后四版DWA及A*代码编写，参数调节，运动可视化绘制。裱糊匠、救火队员。
 - **杨佳昕**：DWA算法设计，后四版DWA及main代码编写，参数调节，视频及log录制。鬼点子贡献者、点火队员。
 - **汤坤逸**：前两版基础的DWA和A\*代码，更快速的版本改良。点火队员。


&nbsp;
&nbsp;
##### CAMXINIBOT 2ND VERSION
##### 30 MAR, 2025
